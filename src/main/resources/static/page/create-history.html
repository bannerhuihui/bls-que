<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建问卷</title>
    <link rel="stylesheet" href="/css/layui.css">
    <link rel="stylesheet" href="/css/create-history.css">
</head>
<body>
<div class="centered-form">
    <div class="form-container">
        <h1 class="title">添加问卷</h1>
        <form class="layui-form" action="" style="padding-bottom: 30px">
            <input type="text" hidden name="userId" th:value="${userId}">
            <div class="layui-form-item">
                <label class="layui-form-label">订单号</label>
                <div class="layui-input-block  layui-input-wrap">
                    <input type="text" name="orderId" placeholder="请输入订单号" class="layui-input ">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">选择平台</label>
                <div class="layui-input-block">
                    <select name="otherName" lay-filter="aihao" lay-verify="checkOtherName">
                        <option value="0">---请选择平台---</option>
                        <option value="抖音">抖音</option>
                        <option value="微信">微信</option>
                        <option value="天猫">天猫</option>
                        <option value="京东">京东</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">套餐价格</label>
                <div class="layui-input-block">
                    <select name="orderMoney" lay-filter="aihao" lay-verify="checkOrderMoney">
                        <option value="0">---请选择套餐价格---</option>
                        <option value="4980">4980</option>
                        <option value="2980">2980</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">套餐类型</label>
                <div class="layui-input-block">
                    <select name="orderType" lay-filter="aihao" lay-verify="checkOrderType">
                        <option value="0">---请选择套餐---</option>
                        <option value="高血压">高血压</option>
                        <option value="高血脂">高血脂</option>
                        <option value="高血糖">高血糖</option>
                        <option value="肠道">肠道</option>
                        <option value="综合免疫">综合免疫</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">收件人姓名</label>
                <div class="layui-input-block layui-input-wrap">
                    <input type="tel" name="orderRecipient" lay-verify="required|checkUserName" placeholder="请填写收件人姓名"
                           class="layui-input demo-phone">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">手机号</label>
                <div class="layui-input-block layui-input-wrap">
                    <input type="tel" name="orderPhone" lay-verify="required|phone" placeholder="请填写收件人手机号"
                           class="layui-input demo-phone">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">预付款</label>
                <div class="layui-input-block  layui-input-wrap">
                    <input type="text" value="0" name="priceBefore" placeholder="单位（元）" class="layui-input " min="0" step="10" lay-affix="number">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">地址</label>
                <div class="layui-input-block layui-input-wrap sel">
                    <select name="orderProvince" id="province" lay-filter="province" lay-verify="checkProvince">
                        <option value="0">请选择省</option>
                    </select>
                </div>
                <div class="layui-input-block layui-input-wrap sel">
                    <select name="orderCity" id="city" lay-filter="city" lay-verify="checkCity">
                        <option value="0">请选择市</option>
                    </select>
                </div>
                <div class="layui-input-block layui-input-wrap sel">
                    <select name="orderCounty" id="area" lay-verify="checkArea">
                        <option value="0">请选择县/区</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">详细地址</label>
                <div class="layui-input-block">
                    <textarea placeholder="请输入详细地址" name="orderAddress" lay-verify="required" class="layui-textarea"></textarea>
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">平台备注</label>
                <div class="layui-input-block">
                    <textarea placeholder="请输入平台备注" name="orderRemark" class="layui-textarea"></textarea>
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">个人备注</label>
                <div class="layui-input-block">
                    <textarea placeholder="请输入个人备注" name="remark" class="layui-textarea"></textarea>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button type="submit" class="layui-btn" lay-submit lay-filter="demo1">确认</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>

</div>


<!-- 请勿在项目正式环境中引用该 layui.js 地址 -->
<script src="/js/layui.js"></script>
<script src="/js/common.js"></script>
<script>
    layui.use(['form','util','jquery'], function () {
        var form = layui.form;
        var $ = layui.jquery;
        var util = layui.util;
        util.on('lay-on',{
            "success": function(){
                layer.alert('提交成功');
            }, "error": function(){
                layer.alert('提交失败');
            }
        })
        form.verify({
            phone: function (value) {
                var phoneReg = /^1[3-9]\d{9}$/; // 简单的手机号正则
                if (!phoneReg.test(value)) {
                    return '请输入有效的手机号';
                }
            },
            checkOtherName: function (value){
                if(value === "0"){
                    return '请选择平台'
                }
            },
            checkOrderMoney: function (value){
                if(value === "0"){
                    return '请选择套餐价格'
                }
            },
            checkOrderType: function (value){
                if(value === "0"){
                    return '请选择套餐类型'
                }
            },
            checkProvince: function (value){
                if(value === "0"){
                    return '请选择省'
                }
            },
            checkCity: function (value){
                if(value === "0"){
                    return '请选择市'
                }
            },
            checkArea: function (value){
                if(value === "0"){
                    return '请选择县/区'
                }
            },
            checkUserName: function (value,){
                if (!new RegExp("^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$").test(value)) {
                    return '用户名不能有特殊字符';
                }
                if (/(^_)|(__)|(_+$)/.test(value)) {
                    return '用户名首尾不能出现下划线';
                }
                if (/^\d+$/.test(value)) {
                    return '用户名不能全为数字';
                }
            }
        });
        //获取所有的省
        $.ajax({
            url:"https://api.rtyouth.com/openapi/getregion.ashx?pid=0",
            type:"GET",
            async: false,
            success:function (data) {
                var provinces =  data.Value;
                for (let i = 0; i < provinces.length; i++) {
                    $("[name='orderProvince']").append(new Option(provinces[i].RegionName, provinces[i].RegionID));
                }
                // 渲染表单
                form.render('select');
            }
        });
        form.on('select(province)',function (data){
            let now_provice = data.value;
            $('#city').empty();
            $('#area').empty();
            $('#city').append(new Option("请选择市", "0"));

            $.ajax({
                url:"https://api.rtyouth.com/openapi/getregion.ashx?pid="+now_provice,
                type:"GET",
                async: false,
                success:function (data) {
                    var city =  data.Value;
                    for (let i = 0; i < city.length; i++) {
                        $('#city').append(new Option(city[i].RegionName, city[i].RegionID));
                    }
                }
            });
            $('#area').append(new Option("请选择县/区", "0"));
            // 渲染表单
            form.render('select');
        });
        form.on('select(city)',function (data){
            let now_city= data.value;
            $('#area').append(new Option("请选择县/区", "0"));
            $.ajax({
                url:"https://api.rtyouth.com/openapi/getregion.ashx?pid="+now_city,
                type:"GET",
                async: false,
                success:function (data) {
                    var area =  data.Value;
                    for (let i = 0; i < area.length; i++) {
                        $('#area').append(new Option(area[i].RegionName, area[i].RegionID));
                    }
                }
            });
            // 渲染表单
            form.render('select');
        });

        // 提交事件
        form.on('submit(demo1)', function (data) {
            var formData = data.field; // 获取表单字段值
            formData.userId = window.parent.userId;
            formData.orderMoney = parseInt(formData.orderMoney, 10);
            formData.priceBefore = parseInt(formData.priceBefore,10);
            formData.userId = parseInt(formData.userId,10);
            formData.orderProvince = $('#province option:selected').text();
            formData.orderCity = $('#city option:selected').text();
            formData.orderCounty = $('#area option:selected').text();
            if(formData.otherName === "0"){

            }
            $.ajax({
                url:"/history/createdHistory",
                type:"POST",
                data:formData,
                success:function (data) {
                    console.log(data);
                    if(data === "success"){
                        alert('添加成功');
                    }else {
                        alert("添加失败");
                    }
                    //跳转到list页面
                    var iframe = window.parent.document.getElementById('center-iframe');
                    iframe.src = "/page/history-list.html";
                    // 检查是否能够访问父页面
                    if (window.parent) {
                        // 使用 try...catch 来处理潜在的跨域错误
                        try {
                            var parentDocument = window.parent.document;
                            var ddElement = parentDocument.getElementById('history_list');
                            if (ddElement) {
                                ddElement.classList.add('layui-this');
                            } else {
                                console.log('dd element not found');
                            }
                        } catch (error) {
                            console.error('Cannot access parent document: ', error);
                        }
                    } else {
                        console.log('No parent window available');
                    }
                }
            });
            return false; // 阻止默认 form 跳转
        });


    });
</script>
</body>
</html>