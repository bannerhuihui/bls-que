<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>创建用户列表</title>
    <link rel="stylesheet" href="/css/layui.css">
    <style>
        #update-iframe{
            width: 100%;
            height: 100%;
            border: none;
        }
        #demo-laypage-layout-1{
            float: right;
        }
        .title-query-form{
            padding-top: 30px;
            height: 15vh;
        }

        td{
            height: 60px;
        }
        .parent {
            position: relative; /* 必须相对定位父容器 */
            width: 98vw;
            height: 98vh;
            margin-left: 1vw;
            margin-right: 1vw;
            margin-top: 1vh;
            margin-bottom: 1vh;
        }

        .child {
            position: absolute; /* 绝对定位子容器 */
            right: 0; /* 将右边距设为0 */
            bottom: 0; /* 将下边距设为0 */
        }
    </style>
</head>
<body>
<script src="/js/layui.js"></script>
<div class="parent">
    <form class="layui-form title-query-form" action="">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">订&nbsp;单&nbsp;号</label>
                <div class="layui-input-inline">
                    <input type="text" name="orderId" placeholder="订单号" autocomplete="off" class="layui-input ">
                </div>
                <label class="layui-form-label">收&nbsp;件&nbsp;人</label>
                <div class="layui-input-inline">
                    <input type="text" name="orderRecipient"  placeholder="收件人" autocomplete="off" class="layui-input ">
                </div>
                <label class="layui-form-label">手&nbsp;机&nbsp;号</label>
                <div class="layui-input-inline">
                    <input type="text" name="orderPhone"  placeholder="收件人手机号" autocomplete="off" class="layui-input ">
                </div>
                <label class="layui-form-label">网页路径</label>
                <div class="layui-input-inline">
                    <input type="text" name="questionUrl"  placeholder="网页路径" autocomplete="off" class="layui-input ">
                </div>
                <label class="layui-form-label">问卷提交</label>
                <div class="layui-input-inline">
                    <select name="questionState" lay-filter="aihao">
                        <option value="请选择">请选择</option>
                        <option value="已填写">已填写</option>
                        <option value="未填写">未填写</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">平&nbsp;&nbsp;&nbsp;&nbsp;台</label>
                <div class="layui-input-inline">
                    <select name="otherName" lay-filter="aihao">
                        <option value="请选择">请选择</option>
                        <option value="抖音">抖音</option>
                        <option value="微信">微信</option>
                        <option value="天猫">天猫</option>
                        <option value="京东">京东</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <label class="layui-form-label">套餐价格</label>
                <div class="layui-input-inline">
                    <select name="orderMoney" lay-filter="aihao">
                        <option value="请选择">请选择</option>
                        <option value="4980">4980</option>
                        <option value="2980">2980</option>
                    </select>
                </div>
                <label class="layui-form-label">套餐类型</label>
                <div class="layui-input-inline">
                    <select name="orderType" lay-filter="aihao">
                        <option value="请选择">请选择</option>
                        <option value="高血压">高血压</option>
                        <option value="高血脂">高血脂</option>
                        <option value="高血糖">高血糖</option>
                        <option value="肠道">肠道</option>
                        <option value="免疫力">免疫力</option>
                    </select>
                </div>
                <label class="layui-form-label">创建时间</label>
                <div class="layui-input-inline">
                    <div class="layui-input-inline layui-input-wrap">
                        <div class="layui-input-prefix">
                            <i class="layui-icon layui-icon-date"></i>
                        </div>
                        <input type="text" name="beginTime"  lay-verify="date" placeholder="开始" autocomplete="off" class="demo-table-search-date layui-input">
                    </div>
                </div>
                <div class="layui-input-inline">
                    <div class="layui-input-inline layui-input-wrap">
                        <div class="layui-input-prefix">
                            <i class="layui-icon layui-icon-date"></i>
                        </div>
                        <input type="text" name="endTime"  lay-verify="date" placeholder="结束" autocomplete="off" class="demo-table-search-date layui-input">
                    </div>
                </div>
                <button type="submit" class="layui-btn" lay-submit lay-filter="table-search">查询</button>
            </div>
        </div>
    </form>
    <table class="layui-hide" id="history-list" lay-filter="history-list"></table>
    <div id="demo-laypage-layout-1" class="child"></div>
</div>
<script type="text/html" id="barDemo">
    <div class="layui-clear-space">
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-xs" lay-event="more">
            更多
            <i class="layui-icon layui-icon-down"></i>
        </a>
    </div>
</script>
<script>
    function isEmptyResponse(response) {
        if (response === null || response === undefined) {
            return true;
        }

        if (typeof response === "string" && response.trim() === "") {
            return true;
        }

        if (Array.isArray(response) && response.length === 0) {
            return true;
        }

        if (typeof response === "object" && Object.keys(response).length === 0) {
            return true;
        }

        return false;
    }

    function getCurrentTime() {
        var now = new Date();
        var year = now.getFullYear();
        var month = (now.getMonth() + 1).toString().padStart(2, '0'); // 月份从0开始，所以+1
        var day = now.getDate().toString().padStart(2, '0');
        var hours = now.getHours().toString().padStart(2, '0');
        var minutes = now.getMinutes().toString().padStart(2, '0');
        var seconds = now.getSeconds().toString().padStart(2, '0');

        return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
    }


    layui.use(["layer",'dropdown','laypage'], function(){
        var $=layui.$;
        var layer=layui.layer;
        var table = layui.table;
        var form = layui.form;
        var laydate = layui.laydate;
        var dropdown = layui.dropdown;
        var laypage = layui.laypage;
        var total = 0;
        let token = localStorage.getItem('token');
        //将form中的数据进行封装
        var beginTime = $("[name = 'beginTime']").val();
        var endTime = $("[name = 'endTime']").val();
        var orderId = $("[name = 'orderId']").val();
        var orderMoney = $("[name = 'orderMoney']").val();
        var orderPhone = $("[name = 'orderPhone']").val();
        var orderRecipient = $("[name = 'orderRecipient']").val();
        var orderType = $("[name = 'orderType']").val();
        var otherName = $("[name = 'otherName']").val();
        var questionState = $("[name = 'questionState']").val();
        var questionUrl = $("[name = 'questionUrl']").val();
        if(beginTime != ""){
            beginTime = beginTime + " 00:00:00";
            if(endTime === ""){
                endTime =  getCurrentTime();
            }else {
                endTime = endTime + " 23:59:59"
            }
        }else {
            beginTime = null;
            endTime = null;
        }
        if(orderMoney === "请选择"){
            orderMoney = null;
        }else {
            orderMoney = parseInt(orderMoney);
        }
        if(orderType === "请选择"){
            orderType = null;
        }
        if(questionState === "请选择"){
            questionState = null;
        }
        if(otherName === "请选择"){
            otherName = null;
        }
        //加载页面
        var loadData = {
            "userId":parseInt(window.parent.userId),
            "currentPage":1,
            "maxRow":10,
            "beginTime":beginTime,
            "endTime":endTime,
            "orderId":orderId,
            "orderMoney":orderMoney,
            "orderPhone":orderPhone,
            "orderRecipient":orderRecipient,
            "orderType":orderType,
            "otherName":otherName,
            "questionState":questionState,
            "questionUrl":questionUrl
        }
        loadPage(loadData);
        const moreData1 = [{
            title: '问卷网址',
            id: 'queUrl'
        },{
            title: '问卷详情',
            id: 'detail'
        },{
            title: '通知发货',
            id: 'del'
        },{
            title: '查看打印',
            id: 'template'
        }];
        const moreData2 = [{
            title: '问卷网址',
            id: 'queUrl'
        },{
            title: '问卷详情',
            id: 'detail'
        },{
            title: '查看打印',
            id: 'template'
        }];
        const moreData3 = [{
            title: '问卷网址',
            id: 'queUrl'
        }];
        table.on('tool(history-list)', function(obj){ // 双击 toolDouble
            let onLineData = obj.data; // 获得当前行数据
            let moreData = moreData2;
            if(onLineData.syncOrder === '待通知发货'){
                moreData = moreData1;
            }
            if (onLineData.questionState === "未填写"){
                moreData = moreData3;
            }
            if(obj.event === 'edit'){
                layer.open({
                    title: '修改问卷内容',
                    type: 1,
                    area: ['80%','80%'],
                    content: '<div style="padding: 16px;height: 100%"><iframe id="update-iframe" src="/page/update-history.html?onLineData='+ encodeURIComponent(JSON.stringify(onLineData))+'" allowfullscreen></iframe></div>'
                });
            } else if(obj.event === 'more'){
                // 更多 - 下拉菜单
                dropdown.render({
                    elem: this, // 触发事件的 DOM 对象
                    show: true, // 外部事件触发即显示
                    data: moreData,
                    click: function(menudata){
                        if(menudata.id === 'detail'){
                            //查看的历史详情
                            $.ajax({
                                url:"/question/queryQuestionByQid?qid="+onLineData.questionId,
                                type:"GET",
                                headers: {
                                    'Authorization': token
                                },
                                success:function (data,textStatus, xhr) {
                                    var redirectUrl = xhr.getResponseHeader('X-Redirect');
                                    if (redirectUrl) {
                                        window.parent.location.href = redirectUrl;
                                    }else {
                                        layer.open({
                                            title: '用户提交的详细信息',
                                            type: 1,
                                            area: ['80%','80%'],
                                            content: '<div id="que-all" style="padding: 16px;height: 100%"></div>'
                                        });
                                        if(!isEmptyResponse(data)){
                                            var otherText = JSON.parse(data.otherText);
                                            let aue_all_text = "个人信息：<br><p>姓名："
                                                +otherText.name+"</p><br><p>生日："
                                                +data.birthday+"</p><br><p>性别："
                                                +data.gender+"</p><br><p>身高："
                                                +data.height+"</p><br><p>体重："+
                                                data.weight+"</p><br><p>腰围："+
                                                data.waist+"</p><br>健康状况评估：<br>您的直系亲属（父母/祖父母/外祖父母）患有以下疾病吗?<br><p>"+
                                                otherText.familyDisease+"</p><br>您是否被医院诊断为以下代谢疾病?<br><p>"+
                                                otherText.metabolicDiseases+"</p><br>您一周的喝酒量是?<br><p>"+
                                                otherText.drinkWeek+"</p><br>您平时的烟草接触情况?<br><p>"+
                                                otherText.smoking+"</p><br>您一天的睡眠时长是?<br><p>"+
                                                otherText.sleepOneDay+"</p><br>您的睡眠质量怎么样?<br><p>"+
                                                otherText.sleepQuality+"</p><br>您是否长期处于紧张焦虑当中或高压力工作中?<br><p>"+
                                                otherText.work+"</p><br>您每天的运动量?<br><p>"+
                                                otherText.amount+"</p><br>您的排便情况?<br><p>"+
                                                otherText.defecation+"</p><br>以下描述哪项更贴近您的饮食习惯?<br><p>"+
                                                otherText.foodShort+"</p><br>您是否有以下症状：<br><p>"+
                                                otherText.otherDisease+"</p><br>目前最想解决的健康问题（单选）<br><p>"+
                                                otherText.needs+"</p>";
                                            $("#que-all").html(aue_all_text);
                                        } else {
                                            $("#que-all").html("<h2>用户暂时还没有填写问卷哟！</h2>");
                                        }
                                    }
                                },
                                error: function(e){
                                    console.log(e)
                                }
                            });

                        } else if(menudata.id === 'del'){
                            layer.confirm('要同步该条数据么？', function(index){
                                if(onLineData.id !== null && onLineData.id !== "" && onLineData.id !== undefined){
                                    $.ajax({
                                        url:"/history/syncOrderToFD/"+onLineData.id,
                                        type:"GET",
                                        headers: {
                                            'Authorization': token
                                        },
                                        success:function (data,textStatus, xhr) {
                                            var redirectUrl = xhr.getResponseHeader('X-Redirect');
                                            if (redirectUrl) {
                                                window.parent.location.href = redirectUrl;
                                            }else {
                                                layer.close(index);
                                                if(data === "success"){
                                                    layer.msg('通知发货成功', {icon: 1, time: 800}, function() {
                                                        // 删除成功后，在2秒钟后刷新父页面
                                                        setTimeout(function() {
                                                            if (window.parent) {
                                                                window.parent.layer.msg('通知发货成功', {icon: 1, time: 800});
                                                                window.parent.location.reload();
                                                            }
                                                        }, 800);
                                                    });
                                                }else {
                                                    layer.msg('通知发货失败', {icon: 2, time: 800}, function() {
                                                        // 删除失败的提示
                                                        setTimeout(function() {
                                                            if (window.parent) {
                                                                window.parent.layer.msg('通知发货失败', {icon: 2, time: 800});
                                                                window.parent.location.reload();
                                                            }
                                                        }, 800);
                                                    });
                                                }
                                            }
                                        },
                                        error: function(e){
                                            console.log(e)
                                        }
                                    });
                                }

                            });
                        }else if (menudata.id === 'template'){
                            layer.open({
                                title: '查看打印模版',
                                type: 1,
                                area: ['100%','100%'],
                                content: '<iframe style="height: 100% ;width: 100%"  src="https://ai.zhycit.com/hyd/'+onLineData.orderId +'"></iframe>'
                            });
                        }else {
                            layer.open({
                                title: '查看问卷网址',
                                type: 1,
                                area: ['50%','50%'],
                                content: '<div style="margin: 30px;font-size: 30px;">问卷网址<br/><br/>'+onLineData.questionUrl+'</div>'
                            });
                        }
                    },
                    align: 'right', // 右对齐弹出
                    style: 'box-shadow: 1px 1px 10px rgb(0 0 0 / 12%);' // 设置额外样式
                })
            }
        });
        // 日期
        laydate.render({
            elem: '.demo-table-search-date'
        });

        laypage.render({
            elem: 'demo-laypage-layout-1',
            count: total,
            layout: ['prev', 'page', 'next'],
            limit: 10,
            jump: function (obj,first){
                var beginTime = $("[name = 'beginTime']").val();
                var endTime = $("[name = 'endTime']").val();
                var orderId = $("[name = 'orderId']").val();
                var orderMoney = $("[name = 'orderMoney']").val();
                var orderPhone = $("[name = 'orderPhone']").val();
                var orderRecipient = $("[name = 'orderRecipient']").val();
                var orderType = $("[name = 'orderType']").val();
                var otherName = $("[name = 'otherName']").val();
                var questionState = $("[name = 'questionState']").val();
                var questionUrl = $("[name = 'questionUrl']").val();
                if(beginTime != ""){
                    beginTime = beginTime + " 00:00:00";
                    if(endTime === ""){
                        endTime =  getCurrentTime();
                    }else {
                        endTime = endTime + "23:59:59";
                    }
                }else {
                    beginTime = null;
                    endTime = null;
                }
                if(orderMoney === "请选择"){
                    orderMoney = null;
                }else {
                    orderMoney = parseInt(orderMoney);
                }
                if(orderType === "请选择"){
                    orderType = null;
                }
                if(questionState === "请选择"){
                    questionState = null;
                }
                if(otherName === "请选择"){
                    otherName = null;
                }
                //加载页面
                var nextAndBefore = {
                    "userId":parseInt(window.parent.userId),
                    "currentPage":1,
                    "maxRow":10,
                    "beginTime":beginTime,
                    "endTime":endTime,
                    "orderId":orderId,
                    "orderMoney":orderMoney,
                    "orderPhone":orderPhone,
                    "orderRecipient":orderRecipient,
                    "orderType":orderType,
                    "otherName":otherName,
                    "questionState":questionState,
                    "questionUrl":questionUrl
                }
                var pageAction = obj.pages > 1 ? (obj.curr === 1 ? "prev" : "next") : "";
                if (pageAction === "prev") {
                    // 这是上一页的点击事件
                    if(!first){
                        nextAndBefore.currentPage = obj.curr;
                    }
                } else if (pageAction === "next") {
                    // 这是下一页的点击事件
                    nextAndBefore.currentPage = obj.curr;
                }

                loadPage(nextAndBefore);
            }
        });

        function loadPage(listData){
            $.ajax({
                url:"/history/queryHistoryList",
                type:"POST",
                headers: {
                    'Authorization': token
                },
                async: false,
                data: listData,
                success:function (data,textStatus, xhr) {
                    var redirectUrl = xhr.getResponseHeader('X-Redirect');
                    if (redirectUrl) {
                        window.parent.location.href = redirectUrl;
                    } else {
                        var listData = data.dataList;
                        total = data.total;
                        table.render({
                            elem: '#history-list',
                            cols: [
                                [ //标题栏
                                    {field: 'orderId', title: '订单号',},
                                    {field: 'otherName', title: '平台',},
                                    {field: 'orderType', title: '套餐类型',},
                                    {field: 'orderRecipient', title: '收件人',},
                                    {field: 'orderPhone', title: '收件人手机号',},
                                    {field: 'questionUrl', title: '问卷地址',},
                                    {field: 'questionState', title: '状态', templet: function (q){
                                            if(q.questionState === "未填写"){
                                                return '<span style="color:red;">' + q.questionState + '</span>';
                                            }
                                            return '<span >' + q.questionState + '</span>';
                                        }},
                                    {field: 'orderMoney', title: '订单金额(元)',},
                                    {field: 'createdTime', title: '创建时间',},
                                    {field: 'syncOrder', title: '订单推送',templet: function(d) {
                                            // 根据syncOrder的值来设置不同的背景色
                                            var bgColor;
                                            if (d.syncOrder === '已通知发货') {
                                                bgColor = '#5FB878'; // 例如：绿色
                                            } else if (d.syncOrder === '待通知发货') {
                                                bgColor = '#FFB800'; // 例如：黄色
                                            } else {
                                                bgColor = '#FF5722'
                                            }
                                            if(d.syncOrder === null){
                                                d.syncOrder = ''
                                            }
                                            // 返回带背景色的HTML
                                            return '<span style="background-color:' + bgColor + ';">' + d.syncOrder + '</span>';
                                        }},
                                    {fixed: 'right', title:'操作', width: 134, minWidth: 125, unresize: true, toolbar: '#barDemo'}
                                ]
                            ],
                            data: listData,
                        });
                    }
                },
                error: function(e){
                    console.log(e)
                }
            });
        }

        // 搜索提交
        form.on('submit(table-search)', function(data){
            var beginTime = $("[name = 'beginTime']").val();
            var endTime = $("[name = 'endTime']").val();
            var orderId = $("[name = 'orderId']").val();
            var orderMoney = $("[name = 'orderMoney']").val();
            var orderPhone = $("[name = 'orderPhone']").val();
            var orderRecipient = $("[name = 'orderRecipient']").val();
            var orderType = $("[name = 'orderType']").val();
            var otherName = $("[name = 'otherName']").val();
            var questionState = $("[name = 'questionState']").val();
            var questionUrl = $("[name = 'questionUrl']").val();
            if(beginTime != ""){
                beginTime = beginTime + " 00:00:00";
                if(endTime === ""){
                    endTime =  getCurrentTime();
                }else {
                    endTime = endTime + " 23:59:59"
                }
            }else {
                beginTime = null;
                endTime = null;
            }
            if(orderMoney === "请选择"){
                orderMoney = null;
            }else {
                orderMoney = parseInt(orderMoney);
            }
            if(orderType === "请选择"){
                orderType = null;
            }
            if(questionState === "请选择"){
                questionState = null;
            }
            if(otherName === "请选择"){
                otherName = null;
            }
            //加载页面
            var queryData = {
                "userId":parseInt(window.parent.userId),
                "currentPage":1,
                "maxRow":10,
                "beginTime":beginTime,
                "endTime":endTime,
                "orderId":orderId,
                "orderMoney":orderMoney,
                "orderPhone":orderPhone,
                "orderRecipient":orderRecipient,
                "orderType":orderType,
                "otherName":otherName,
                "questionState":questionState,
                "questionUrl":questionUrl
            }
            loadPage(queryData);
            laypage.render({
                elem: 'demo-laypage-layout-1',
                count: total,
                layout: ['prev', 'page', 'next'],
                limit: 10,
                jump: function (obj,first){
                    var beginTime = $("[name = 'beginTime']").val();
                    var endTime = $("[name = 'endTime']").val();
                    var orderId = $("[name = 'orderId']").val();
                    var orderMoney = $("[name = 'orderMoney']").val();
                    var orderPhone = $("[name = 'orderPhone']").val();
                    var orderRecipient = $("[name = 'orderRecipient']").val();
                    var orderType = $("[name = 'orderType']").val();
                    var otherName = $("[name = 'otherName']").val();
                    var questionState = $("[name = 'questionState']").val();
                    var questionUrl = $("[name = 'questionUrl']").val();
                    if(beginTime != ""){
                        beginTime = beginTime + " 00:00:00";
                        if(endTime === ""){
                            endTime =  getCurrentTime();
                        }else {
                            endTime = endTime + " 23:59:59"
                        }
                    }else {
                        beginTime = null;
                        endTime = null;
                    }
                    if(orderMoney === "请选择"){
                        orderMoney = null;
                    }else {
                        orderMoney = parseInt(orderMoney);
                    }
                    if(orderType === "请选择"){
                        orderType = null;
                    }
                    if(questionState === "请选择"){
                        questionState = null;
                    }
                    if(otherName === "请选择"){
                        otherName = null;
                    }
                    //加载页面
                    var nextAndBefore = {
                        "userId":parseInt(window.parent.userId),
                        "currentPage":1,
                        "maxRow":10,
                        "beginTime":beginTime,
                        "endTime":endTime,
                        "orderId":orderId,
                        "orderMoney":orderMoney,
                        "orderPhone":orderPhone,
                        "orderRecipient":orderRecipient,
                        "orderType":orderType,
                        "otherName":otherName,
                        "questionState":questionState,
                        "questionUrl":questionUrl
                    }
                    var pageAction = obj.pages > 1 ? (obj.curr === 1 ? "prev" : "next") : "";
                    if (pageAction === "prev") {
                        // 这是上一页的点击事件
                        if(!first){
                            nextAndBefore.currentPage = obj.curr;
                        }
                    } else if (pageAction === "next") {
                        // 这是下一页的点击事件
                        nextAndBefore.currentPage = obj.curr;
                    }

                    loadPage(nextAndBefore);
                }
            });
            return false; // 阻止默认 form 跳转
        });
    });
</script>
</body>
</html>